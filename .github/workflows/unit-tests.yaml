name: nvidia-rtx-3090 tests

on:
  push:
    branches: [ develop ]
  pull_request:
    branches: [ develop ]


jobs:
  formatting:
    runs-on: [ubuntu-latest]

    steps:
    - uses: actions/checkout@v2
    - name: Set up Python 3.9
      uses: actions/setup-python@v2
      with:
        python-version: 3.9

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install flake8 pytest

    - name: Update black
      run: |
        pip install --upgrade black

    - name: Lint and Format Check with flake8 and black
      run: |
        black --diff --check .
        flake8

  inter-layer:
    needs: formatting
    runs-on: [ nvidia ]

    strategy:
      matrix:
        ginter: [ 1, 2 ]
        memopt: [ '0', '1' ]

    steps:
    - uses: actions/checkout@v3
    - name: Install AxoNN
      run: |
        pip install -r requirements.txt
    - name: Download dataset
      run: |
        python -c "import torchvision; torchvision.datasets.MNIST(root=\"./axonn/tests\", download=True, train=True)"
    - name: Train 
      run: |
        export G_inter=${{ matrix.ginter }}
        export G_data=$(( 2 / G_inter ))
        export memopt=${{ matrix.memopt }}
        echo "training with G_inter = ${G_inter}, G_data = $(( 2 / G_inter  )) ${{ matrix.memopt }}" 
        mpirun -n 2 pytest --with-mpi ./axonn/tests/test_vit.py 
    - name: Uninstall AxoNN
      run: |
        pip uninstall --yes axonn


  intra-layer:
    needs: formatting
    runs-on: [ nvidia ]

    steps:
    - uses: actions/checkout@v3
    - name: Install AxoNN
      run: |
        pip install -r requirements.txt
    - name: Run unit intra-layer unit tests 
      run: |
        mpirun -n 2 pytest --with-mpi ./axonn/tests/test_intra_layer_fc.py 
    - name: Uninstall AxoNN
      run: |
        pip uninstall --yes axonn
